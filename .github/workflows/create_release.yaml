name: Create Release

env:
  CI: true

on:
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: pwsh

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Enable long paths in Git
      run: git config --system core.longpaths true

    - name: Enable Win32 long paths at runtime
      shell: pwsh
      run: reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f

    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Extract version from version.h
      id: extract_version
      shell: bash
      run: |
        VERSION_FILE="ASI Mod/src/resources/version.h"
        echo "Reading version from $VERSION_FILE"

        VERSION_MAJOR=$(grep '#define VERSION_MAJOR' "$VERSION_FILE" | awk '{print $3}')
        VERSION_MINOR=$(grep '#define VERSION_MINOR' "$VERSION_FILE" | awk '{print $3}')
        VERSION_PATCH=$(grep '#define VERSION_PATCH' "$VERSION_FILE" | awk '{print $3}')

        version="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_PATCH}"
        echo "Parsed version: $version"

        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # -------------------------
    # Prepare output structure
    # -------------------------
    - name: Create dist folder structure
      shell: pwsh
      run: |
        $targets = @("dist", "dist_2x", "dist_4x")
        $subdirs = @("plugins", "logs", "textures")

        foreach ($t in $targets) {
          New-Item -ItemType Directory -Path $t -Force | Out-Null
          foreach ($s in $subdirs) {
            New-Item -ItemType Directory -Path "$t/$s" -Force | Out-Null
          }
        }


    # -------------------------
    # Build
    # -------------------------
    - name: Build
      run: msbuild "ASI Mod\${{ github.event.repository.name }}.sln" /m -t:rebuild -verbosity:minimal -property:Configuration=Release -property:Platform=x64  -property:PlatformToolset=v143

    - name: Copy ASI files into all dist folders
      shell: pwsh
      run: |
        $targets = @("dist", "dist_2x", "dist_4x")

        foreach ($t in $targets) {
          Write-Host "Copying to $t"

          Copy-Item "ASI Mod\x64\Release\${{ github.event.repository.name }}.asi" "$t/plugins/${{ github.event.repository.name }}.asi" -Force
          Copy-Item "ASI Mod\${{ github.event.repository.name }}.ini" "$t/plugins/${{ github.event.repository.name }}.ini" -Force

          Copy-Item README.md "$t/logs/${{ github.event.repository.name }}.log" -Force
          Copy-Item LICENSE "$t/plugins/${{ github.event.repository.name }}_LICENSE" -Force
        }


    # Build Dist Folders
    - name: Build Dist Folders
      run: |
        $RepoRootDir = "${{ github.workspace }}"
        $scriptPath  = Join-Path $RepoRootDir "Build_Dist_Folders.py"

        if (-not (Test-Path $scriptPath)) {
          Write-Error "Build_Dist_Folders.py not found at $scriptPath"
          exit 1
        }

        Write-Host "Running Build_Dist_Folders.py..."
        py $scriptPath


    # Package everything
    - name: Create Base release zip
      working-directory: dist
      run: 7z a -tzip "../${{ github.event.repository.name }}}_v${{ steps.extract_version.outputs.version }}_Original_Resolution.zip" *

    - name: Create 2x Upscaled release zip
      working-directory: dist_2x
      run: 7z a -tzip "../${{ github.event.repository.name }}_v${{ steps.extract_version.outputs.version }}_2x_Upscaled_Addon.zip" *

    - name: Create 4x Upscaled release zip
      working-directory: dist_4x
      run: 7z a -tzip "../${{ github.event.repository.name }}_v${{ steps.extract_version.outputs.version }}_4x_Upscaled_Addon.zip" *

    - name: Generate Release Posting
      uses: ncipollo/release-action@v1
      with:
        artifacts: >
          ${{ github.event.repository.name }}_v${{ steps.extract_version.outputs.version }}_Original_Resolution.zip,
          ${{ github.event.repository.name }}_v${{ steps.extract_version.outputs.version }}_2x_AI_Upscaled.zip,
          ${{ github.event.repository.name }}_v${{ steps.extract_version.outputs.version }}_4x_AI_Upscaled.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ steps.extract_version.outputs.version }}
        name: "${{ steps.extract_version.outputs.version }}"
        draft: true
        generateReleaseNotes: true
        artifactErrorsFailBuild: true